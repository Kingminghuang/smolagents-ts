digraph Node_CodeAgent_Tools_Validation {
    graph [goal="Validate CodeAgent's ability to generate correct code for file system tools"]
    node [shape=box, timeout="600s"]

    start [shape=Mdiamond, label="Start"]
    exit  [shape=Msquare, label="All Tests Passed"]
    
    // Setup phase
    setup_baseline [
        label="Generate Baseline Output",
        prompt="Run tests/utils/node-fs-tools-runner.ts to generate baseline tool execution outputs. This creates the expected outputs for comparison."
    ]
    
    // Read Tool Tests (Tests 1-11)
    subgraph cluster_read_tests {
        label="Read Tool Tests"
        
        test_read_01 [
            label="Test 1: Read normal file",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named test.txt with the content:\nHello, world!\nLine 2\nLine 3\nThen read the file test.txt.\nFinally output the read result.'\n\nSatisfaction: CodeAgent generates code that executes successfully and output matches baseline Test 1 from node-fs-tools-runner.ts"
        ]
        
        test_read_02 [
            label="Test 2: Read non-existent file",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Ensure that a file named nonexistent.txt does not exist (delete it if it does). Then try to read the file nonexistent.txt. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code that executes and output matches baseline Test 2 (should show error)"
        ]
        
        test_read_03 [
            label="Test 3: Truncate line limit",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named large.txt with 2500 lines, where each line follows the pattern Line N (e.g., Line 1, Line 2... Line 2500). Then read the file large.txt. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code that shows truncation at 2000 lines matching baseline Test 3"
        ]
        
        test_read_04 [
            label="Test 4: Truncate byte limit",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named large-bytes.txt with 500 lines. Each line should be Line N: followed by 200 x characters. Then read the file large-bytes.txt. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code showing byte limit truncation matching baseline Test 4"
        ]
        
        test_read_05 [
            label="Test 5: Read with offset",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named offset-test.txt with 100 lines, where each line is Line N. Then read offset-test.txt starting from line 51. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code with output starting from Line 51 matching baseline Test 5"
        ]
        
        test_read_06 [
            label="Test 6: Read with limit",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named limit-test.txt with 100 lines, where each line is Line N. Then read the first 10 lines of limit-test.txt. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code showing only first 10 lines matching baseline Test 6"
        ]
        
        test_read_07 [
            label="Test 7: Read with offset+limit",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named offset-limit-test.txt with 100 lines, where each line is Line N. Then read 20 lines from offset-limit-test.txt starting at line 41. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code showing lines 41-60 matching baseline Test 7"
        ]
        
        test_read_08 [
            label="Test 8: Offset beyond file",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named short.txt with 3 lines: Line 1, Line 2, Line 3. Then try to read short.txt starting from line 100. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code showing appropriate error matching baseline Test 8"
        ]
        
        test_read_09 [
            label="Test 9: Truncation details",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named large-file.txt with 2500 lines, where each line is Line N. Then read the file large-file.txt. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code with truncation metadata matching baseline Test 9"
        ]
        
        test_read_10 [
            label="Test 10: Image MIME detection",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named image.txt containing the binary buffer of a valid 1x1 PNG image (base64: iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+X2Z0AAAAASUVORK5CYII=). Then read the file image.txt. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code detecting PNG MIME type matching baseline Test 10"
        ]
        
        test_read_11 [
            label="Test 11: Fake image as text",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named not-an-image.png with the text content definitely not a png. Then read the file not-an-image.png. Finally output the read result.'\n\nSatisfaction: CodeAgent generates code treating file as text matching baseline Test 11"
        ]
    }
    
    // Write Tool Tests (Tests 12-13)
    subgraph cluster_write_tests {
        label="Write Tool Tests"
        
        test_write_12 [
            label="Test 12: Write file",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Ensure write-test.txt does not exist. Then write the text Test content to write-test.txt. Finally output the write result.'\n\nSatisfaction: CodeAgent generates code creating file with correct content matching baseline Test 12"
        ]
        
        test_write_13 [
            label="Test 13: Create parent dirs",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Ensure the directory nested/dir does not exist. Then write the text Nested content to nested/dir/test.txt. Finally output the write result.'\n\nSatisfaction: CodeAgent generates code creating parent directories and file matching baseline Test 13"
        ]
    }
    
    // Edit Tool Tests (Tests 14-29)
    subgraph cluster_edit_tests {
        label="Edit Tool Tests"
        
        test_edit_14 [
            label="Test 14: Replace text",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named edit-test.txt with content Hello, world!. Then, in edit-test.txt, replace world with testing. Finally output the edit result.'\n\nSatisfaction: CodeAgent generates code replacing text successfully matching baseline Test 14"
        ]
        
        test_edit_15 [
            label="Test 15: Text not found",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named edit-test.txt with content Hello, world!. Then, in edit-test.txt, try to replace nonexistent with testing. Finally output the edit result.'\n\nSatisfaction: CodeAgent generates code showing appropriate error matching baseline Test 15"
        ]
        
        test_edit_16 [
            label="Test 16: Multiple occurrences",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named edit-test.txt with content foo foo foo. Then, in edit-test.txt, try to replace foo with bar. Finally output the edit result.'\n\nSatisfaction: CodeAgent generates code showing error for multiple matches matching baseline Test 16"
        ]
        
        test_edit_17 [
            label="Test 17: Trailing whitespace",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named trailing-ws.txt with content: line one (with 3 trailing spaces), line two (with 2 trailing spaces), line three. Then, in trailing-ws.txt, replace the text line one newline line two newline with replaced newline. Finally output the edit result and the content of the file.'\n\nSatisfaction: CodeAgent generates code succeeding with whitespace normalization matching baseline Test 17"
        ]
    }
    
    // Grep Tool Tests (Tests 30-31)
    subgraph cluster_grep_tests {
        label="Grep Tool Tests"
        
        test_grep_30 [
            label="Test 30: Single file search",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named example.txt with content: first line, match line, last line. Then search for match in example.txt. Finally output the search result.'\n\nSatisfaction: CodeAgent generates code with output including filename and line number matching baseline Test 30"
        ]
        
        test_grep_31 [
            label="Test 31: Limit and context",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named context.txt with content: before, match one, after, middle, match two, after two. Then search for match in context.txt showing 1 line of context, and limit results to 1 match. Finally output the search result.'\n\nSatisfaction: CodeAgent generates code showing context lines and respecting limit matching baseline Test 31"
        ]
    }
    
    // Find Tool Tests (Tests 32-33)
    subgraph cluster_find_tests {
        label="Find Tool Tests"
        
        test_find_32 [
            label="Test 32: Hidden files",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a hidden directory .secret/ and a file inside .secret/hidden.txt. Also create a file visible.txt. Then find all text files (**/*.txt) in the current directory. Finally output the find result.'\n\nSatisfaction: CodeAgent generates code with output including hidden files matching baseline Test 32"
        ]
        
        test_find_33 [
            label="Test 33: .gitignore respect",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a file named .gitignore with content ignored.txt. Create ignored.txt and kept.txt. Then find all text files (**/*.txt) in the current directory. Finally output the find result.'\n\nSatisfaction: CodeAgent generates code with output excluding gitignored files matching baseline Test 33"
        ]
    }
    
    // Ls Tool Tests (Test 34)
    subgraph cluster_ls_tests {
        label="Ls Tool Tests"
        
        test_ls_34 [
            label="Test 34: List dotfiles",
            prompt="Initialize a CodeAgent with ReadTool, WriteTool, EditTool, GrepTool, FindTool, and LsTool.\n\nThen run the CodeAgent with the following task:\n'Create a hidden file .hidden-file and a hidden directory .hidden-dir. Then list the contents of the current directory. Finally output the ls result.'\n\nSatisfaction: CodeAgent generates code with output including dotfiles and directories matching baseline Test 34"
        ]
    }
    
    // Validation gates
    gate_read [shape=diamond, label="All Read Tests Pass?"]
    gate_write [shape=diamond, label="All Write Tests Pass?"]
    gate_edit [shape=diamond, label="All Edit Tests Pass?"]
    gate_grep [shape=diamond, label="All Grep Tests Pass?"]
    gate_find [shape=diamond, label="All Find Tests Pass?"]
    gate_ls [shape=diamond, label="All Ls Tests Pass?"]
    
    // Final consolidation
    consolidate_results [
        label="Consolidate Results",
        prompt="Review all test outputs and compare with baseline. Generate a summary report showing pass/fail for each test case."
    ]
    
    fix_agent [
        label="Fix CodeAgent Implementation",
        prompt="Analyze failed test cases and update CodeAgent code generation logic to handle the failing scenarios correctly."
    ]
    
    // Flow
    start -> setup_baseline
    
    // Read tests flow
    setup_baseline -> test_read_01
    test_read_01 -> test_read_02
    test_read_02 -> test_read_03
    test_read_03 -> test_read_04
    test_read_04 -> test_read_05
    test_read_05 -> test_read_06
    test_read_06 -> test_read_07
    test_read_07 -> test_read_08
    test_read_08 -> test_read_09
    test_read_09 -> test_read_10
    test_read_10 -> test_read_11
    test_read_11 -> gate_read
    
    // Write tests flow
    setup_baseline -> test_write_12
    test_write_12 -> test_write_13
    test_write_13 -> gate_write
    
    // Edit tests flow
    setup_baseline -> test_edit_14
    test_edit_14 -> test_edit_15
    test_edit_15 -> test_edit_16
    test_edit_16 -> test_edit_17
    test_edit_17 -> gate_edit
    
    // Grep tests flow
    setup_baseline -> test_grep_30
    test_grep_30 -> test_grep_31
    test_grep_31 -> gate_grep
    
    // Find tests flow
    setup_baseline -> test_find_32
    test_find_32 -> test_find_33
    test_find_33 -> gate_find
    
    // Ls tests flow
    setup_baseline -> test_ls_34
    test_ls_34 -> gate_ls
    
    // Gates to consolidation
    gate_read -> consolidate_results [label="Yes", condition="outcome=success"]
    gate_write -> consolidate_results [label="Yes", condition="outcome=success"]
    gate_edit -> consolidate_results [label="Yes", condition="outcome=success"]
    gate_grep -> consolidate_results [label="Yes", condition="outcome=success"]
    gate_find -> consolidate_results [label="Yes", condition="outcome=success"]
    gate_ls -> consolidate_results [label="Yes", condition="outcome=success"]
    
    // Failures route to fix
    gate_read -> fix_agent [label="No", condition="outcome!=success"]
    gate_write -> fix_agent [label="No", condition="outcome!=success"]
    gate_edit -> fix_agent [label="No", condition="outcome!=success"]
    gate_grep -> fix_agent [label="No", condition="outcome!=success"]
    gate_find -> fix_agent [label="No", condition="outcome!=success"]
    gate_ls -> fix_agent [label="No", condition="outcome!=success"]
    
    // Fix agent loops back to setup
    fix_agent -> setup_baseline [label="Retry"]
    
    // Final exit
    consolidate_results -> exit [label="Complete", condition="outcome=success"]
}
