<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>smolagents-ts Browser Directory Demo</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.3/full/pyodide.js"></script>
    <script src="../dist-browser/smolagents.browser.global.js"></script>
    <style>
      :root {
        --bg: #f7f5f0;
        --card: #ffffff;
        --ink: #1f2428;
        --muted: #6b7280;
        --accent: #0c7a6b;
        --accent-dark: #0a6a5d;
        --outline: #e5e7eb;
      }
      body {
        font-family: 'Charter', 'Georgia', serif;
        background: radial-gradient(circle at top left, #f3efe6, var(--bg));
        color: var(--ink);
        margin: 0;
        padding: 24px;
      }
      .container {
        max-width: 980px;
        margin: 0 auto;
      }
      h1 {
        margin: 0 0 12px;
        font-size: 28px;
        letter-spacing: 0.2px;
      }
      p {
        margin: 0 0 16px;
        color: var(--muted);
      }
      .card {
        background: var(--card);
        border: 1px solid var(--outline);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
        margin-bottom: 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }
      input[type='text'],
      input[type='password'] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--outline);
        border-radius: 10px;
        font-size: 14px;
      }
      .actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 16px;
      }
      .toast {
        opacity: 0;
        transform: translateY(4px);
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
        background: #f1f5f9;
        color: var(--ink);
        border: 1px solid var(--outline);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 13px;
      }
      .toast.is-visible {
        opacity: 1;
        transform: translateY(0);
      }
      .helper {
        color: var(--muted);
        font-size: 14px;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 15px;
        transition:
          transform 0.1s ease,
          background 0.2s ease;
      }
      button:hover {
        background: var(--accent-dark);
        transform: translateY(-1px);
      }
      button:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
      }
      #status {
        font-style: italic;
        color: var(--muted);
        margin-bottom: 12px;
      }
      #output {
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        font-family: 'IBM Plex Mono', 'SFMono-Regular', monospace;
        font-size: 13px;
        white-space: pre-wrap;
        min-height: 280px;
        max-height: 520px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>smolagents-ts Browser Directory Demo</h1>
        <p>Use CodeAgent to calculate the total size of a local directory.</p>
        <div class="grid">
          <div>
            <label for="apiKey">OPENAI_API_KEY</label>
            <input type="password" id="apiKey" placeholder="sk-..." value="" />
          </div>
          <div>
            <label for="baseURL">OPENAI_BASE_URL</label>
            <input type="text" id="baseURL" placeholder="https://api.openai.com/v1" value="https://api.deepseek.com" />
          </div>
          <div>
            <label for="model">OPENAI_MODEL</label>
            <input type="text" id="model" placeholder="gpt-4o" value="deepseek-chat" />
          </div>
        </div>
        <div class="actions">
          <button id="pickDirBtn" type="button">Pick Local Directory</button>
          <button id="runBtn" type="button" disabled>Run CodeAgent</button>
          <button id="saveConfigBtn" type="button">Save Settings</button>
          <button id="clearConfigBtn" type="button">Clear Settings</button>
          <button id="clearBtn" type="button">Clear Output</button>
          <span id="toast" class="toast" aria-live="polite"></span>
          <span id="dirName" class="helper">No directory selected</span>
        </div>
      </div>

      <div class="card">
        <div id="status">Waiting for directory selection...</div>
        <div id="output">Output will appear here...</div>
      </div>
    </div>

    <script>
      const {
        CodeAgent,
        OpenAIModel,
        BrowserListDirectoryTool,
        BrowserReadTextFileTool,
        BrowserGetFileInfoTool,
      } = SmolAgents;

      let directoryHandle = null;
      let isRunning = false;
      const outputElement = document.getElementById('output');
      const statusElement = document.getElementById('status');
      const runBtn = document.getElementById('runBtn');
      const dirNameElement = document.getElementById('dirName');
      const pickDirBtn = document.getElementById('pickDirBtn');
      const clearBtn = document.getElementById('clearBtn');
      const saveConfigBtn = document.getElementById('saveConfigBtn');
      const clearConfigBtn = document.getElementById('clearConfigBtn');
      const toastElement = document.getElementById('toast');
      const configKeys = ['OPENAI_API_KEY', 'OPENAI_BASE_URL', 'OPENAI_MODEL'];
      let toastTimer = null;

      function log(message) {
        outputElement.textContent += `${message}\n`;
        outputElement.scrollTop = outputElement.scrollHeight;
      }

      function resetOutput() {
        outputElement.textContent = '';
      }

      function updateStatus(text) {
        statusElement.textContent = text;
      }

      function updateButtons() {
        runBtn.disabled = isRunning || !directoryHandle;
        pickDirBtn.disabled = isRunning;
      }

      function showToast(message) {
        if (toastTimer) {
          clearTimeout(toastTimer);
        }
        toastElement.textContent = message;
        toastElement.classList.add('is-visible');
        toastTimer = setTimeout(() => {
          toastElement.classList.remove('is-visible');
          toastElement.textContent = '';
          toastTimer = null;
        }, 1800);
      }

      function loadConfigFromStorage() {
        const apiKey = localStorage.getItem('OPENAI_API_KEY') || '';
        const baseURL = localStorage.getItem('OPENAI_BASE_URL') || '';
        const modelName = localStorage.getItem('OPENAI_MODEL') || '';
        document.getElementById('apiKey').value = apiKey;
        document.getElementById('baseURL').value = baseURL;
        document.getElementById('model').value = modelName;
      }

      function saveConfigToStorage() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const baseURL = document.getElementById('baseURL').value.trim();
        const modelName = document.getElementById('model').value.trim();
        if (!apiKey) {
          alert('Please enter OPENAI_API_KEY before saving');
          return;
        }
        localStorage.setItem('OPENAI_API_KEY', apiKey);
        localStorage.setItem('OPENAI_BASE_URL', baseURL);
        localStorage.setItem('OPENAI_MODEL', modelName);
        showToast('Settings saved');
      }

      function clearConfigFromStorage() {
        configKeys.forEach((key) => localStorage.removeItem(key));
        document.getElementById('apiKey').value = '';
        document.getElementById('baseURL').value = '';
        document.getElementById('model').value = '';
        showToast('Settings cleared');
      }

      function readConfig() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const baseURL = document.getElementById('baseURL').value.trim();
        const modelName = document.getElementById('model').value.trim();

        if (!apiKey) {
          alert('Please enter OPENAI_API_KEY');
          return null;
        }

        return {
          apiKey,
          baseURL: baseURL || undefined,
          modelName: modelName || 'gpt-4o',
        };
      }

      async function pickDirectory() {
        try {
          directoryHandle = await window.showDirectoryPicker();
          dirNameElement.textContent = `Selected: ${directoryHandle.name}`;
          updateStatus('Ready.');
          updateButtons();
        } catch (err) {
          console.error(err);
          if (err.name !== 'AbortError') {
            alert(`Failed to pick directory: ${err.message}`);
          }
        }
      }

      async function runCodeAgent() {
        const config = readConfig();
        if (!config || !directoryHandle) return;

        resetOutput();
        log('-- CodeAgent Run --');
        isRunning = true;
        updateButtons();
        updateStatus('CodeAgent running...');

        try {
          const model = new OpenAIModel({
            apiKey: config.apiKey,
            baseURL: config.baseURL,
            defaultModel: config.modelName,
            dangerouslyAllowBrowser: true,
          });

          const listTool = new BrowserListDirectoryTool(directoryHandle);
          const readTool = new BrowserReadTextFileTool(directoryHandle);
          const infoTool = new BrowserGetFileInfoTool(directoryHandle);

          const agent = new CodeAgent({
            model,
            tools: [listTool, readTool, infoTool],
            verbosity_level: 2,
            stream_outputs: true,
            authorized_imports: ['*'],
          });

          // log('SYSTEM_PROMPT:');
          // log(agent.get_memory().system_prompt.system_prompt);

          const stream = agent.run(
            'Calculate the total size of all files in this directory recursively. Use list_directory and get_file_info tools to traverse and get sizes. Print the final result clearly.',
            { stream: true }
          );

          for await (const event of stream) {
            if (!event || typeof event !== 'object') continue;

            if ('name' in event && event.name) {
              log(`TOOL_CALL: ${event.name}`);
            }

            if (event.name === 'python_interpreter' && event.arguments?.code) {
              log('CODE:');
              log('```python');
              log(event.arguments.code);
              log('```');
          }

          if ('observation' in event && event.observation) {
            log(`EXECUTION: ${event.observation}`);
            loggedExecution = true;
          }

          if ('is_final_answer' in event && event.is_final_answer) {
            if (!loggedExecution) {
              log('EXECUTION:');
              loggedExecution = true;
            }
            log(
              `FINAL_ANSWER: ${
                typeof event.output === 'string' ? event.output : JSON.stringify(event.output, null, 2)
              }`
            );
          }
        }

          updateStatus('Finished.');
        } catch (err) {
          log(`ERROR: ${err.message || err}`);
          console.error(err);
          updateStatus('Error occurred.');
        } finally {
          isRunning = false;
          updateButtons();
        }
      }

      pickDirBtn.addEventListener('click', () => {
        void pickDirectory();
      });

      runBtn.addEventListener('click', () => {
        void runCodeAgent();
      });

      clearBtn.addEventListener('click', () => {
        resetOutput();
        updateStatus(directoryHandle ? 'Ready.' : 'Waiting for directory selection...');
      });

      saveConfigBtn.addEventListener('click', () => {
        saveConfigToStorage();
      });

      clearConfigBtn.addEventListener('click', () => {
        clearConfigFromStorage();
      });

      loadConfigFromStorage();
    </script>
  </body>
</html>
